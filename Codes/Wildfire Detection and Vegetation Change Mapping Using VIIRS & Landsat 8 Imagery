
// 3. Center the map on the region of interest and display boundaries
Map.centerObject(region,8);
Map.addLayer(region, {}, 'Region of Interest', false);

// 4. Load VIIRS wildfire data, filter by date, and select bands
var viirs_data = ee.ImageCollection("NASA/VIIRS/002/VNP09GA")
  .select(['I1', 'I2'])
  .filterDate('2017-10-08', '2017-10-10');
print(viirs_data);

// 5. Add the VIIRS wildfire layer to the map
Map.addLayer(viirs_data.toBands().clip(region), {}, 'VIIRS Wildfire', false);

// 7. Center map on the new area
Map.addLayer(region, [], 'Study Area');
Map.centerObject(region, 8);

// 8. Load Landsat data before the fire (2024), filter by date, and select bands
var landsat_before = ee.ImageCollection("LANDSAT/LC08/C02/T1_L2")
  .select(['SR_.*'])
/*
This is a regular expression that matches any sequence of characters that follows the prefix SR_. In regular expressions:
. (dot) matches any single character.
* means "zero or more occurrences" of the preceding character.
In this case, SR_.* matches any band that starts with SR_ and is followed by any other characters.
*/
  .filterDate('2023-01-01', '2024-12-31')
  //.filter(ee.Filter.calendarRange(8, 10, 'month'))
  .filterBounds(region);

// 9. Add the 'before fire' image to the map in RGB
Map.addLayer(landsat_before.median().clip(region),
  {min: 8599, max: 18463, bands: ['SR_B5', 'SR_B4', 'SR_B3']}, 'Before Fire (RGB)', false);
print(landsat_before.first(), 'before fire image');

// 10. Load Landsat data after the fire 2024, filter by date, and select bands
var landsat_after = ee.ImageCollection("LANDSAT/LC08/C02/T1_L2")
  .select(['SR_.*'])
  .filterDate('2024-12-31', '2025-01-25')
  .filter(ee.Filter.calendarRange(8, 10, 'month'))
  .filterBounds(region);

// 11. Add the 'after fire' image to the map in RGB
Map.addLayer(landsat_after.median().clip(region),
  {min: 8599, max: 18463, bands: ['SR_B5', 'SR_B4', 'SR_B3']}, 'After Fire (RGB)', false);
print(landsat_after.first(), 'after fire image');

                     // Vegetation Change Mapping Using NDVI Indices //

// 12. Calculate NDVI before the fire
var ndvi_before_fire = landsat_before.map(function(img) {
  var gain_band5 = ee.Number(img.get('REFLECTANCE_MULT_BAND_5'));
  var offset_band4 = ee.Number(img.get('REFLECTANCE_ADD_BAND_3'));
  var scaled_img = img.multiply(gain_band5).add(offset_band4);
  return scaled_img.normalizedDifference(['SR_B5', 'SR_B4']).rename('ndvi_before');
}).median();

// 13. Calculate NDVI after the fire
var ndvi_after_fire = landsat_after.map(function(img) {
  var gain_band5 = ee.Number(img.get('REFLECTANCE_MULT_BAND_5'));
  var offset_band4 = ee.Number(img.get('REFLECTANCE_ADD_BAND_3'));
  var scaled_img = img.multiply(gain_band5).add(offset_band4);
  return scaled_img.normalizedDifference(['SR_B5', 'SR_B4']).rename('ndvi_after');
}).median();

// 14. Add NDVI layers to the map
Map.addLayer(ndvi_before_fire.clip(region), {min: -1, max: 1, palette:['red', 'yellow', 'green']}, 'NDVI Before Fire', false);
Map.addLayer(ndvi_after_fire.clip(region), {min: -1, max: 1, palette:['red', 'yellow', 'green']}, 'NDVI After Fire', false);

  
// 15. Display histogram of NDVI before the fire
print(ui.Chart.image.histogram(ndvi_before_fire, region, 100)
  .setOptions({
    title: 'NDVI Before 2024',
    colors: ['#FF0000'], // Set the color of the bars to red
    hAxis: {title: 'NDVI Value', titleTextStyle: {color: '#333'}},
    vAxis: {title: 'Frequency', titleTextStyle: {color: '#333'}},
    legend: {position: 'none'}, // Remove the legend
    bar: {groupWidth: '95%'} // Reduce bar width for better visibility
  })
);

// 16. Display histogram of NDVI after the fire
print(ui.Chart.image.histogram(ndvi_after_fire, region, 100)
  .setOptions({
    title: 'NDVI After 2024',
    colors: ['#ff7f0e'], // Set the color of the bars to orange
    hAxis: {title: 'NDVI Value', titleTextStyle: {color: '#333'}},
    vAxis: {title: 'Frequency', titleTextStyle: {color: '#333'}},
    legend: {position: 'none'},
    bar: {groupWidth: '95%'}
  })
);

// 17. Calculate the change in NDVI
var ndvi_change = ndvi_before_fire.subtract(ndvi_after_fire);

// 18. Add NDVI change layer to the map
Map.addLayer(ndvi_change.clip(region), {palette:['green', 'red']}, 'NDVI Change', false);

// 19. Apply a water mask to the NDVI change
var water_mask = ee.ImageCollection("GOOGLE/DYNAMICWORLD/V1")
  .select('label').mode().eq(0).not();
Map.addLayer(water_mask.clip(region), {palette:['blue', 'red']}, 'Water Mask', false);

// 20. Mask the NDVI change with the water mask
var ndvi_change_masked = ndvi_change.updateMask(water_mask).rename('ndvi_change_masked');

// 21. Add masked NDVI change layer to the map
Map.addLayer(ndvi_change_masked.clip(region), {palette:['blue', 'green', 'yellow', 'red']}, 'NDVI Change Masked', false);

// 22. Export the NDVI change image to Google Drive
Export.image.toDrive({
  image: ndvi_change_masked.clip(region),
  description: 'NDVI_Change_Masked',
  scale: 100,
  maxPixels: 1e13,
  region: region,
  crs: 'EPSG:4326'
});


// 23. Display histogram of the masked NDVI change
print(ui.Chart.image.histogram(ndvi_change_masked, region, 1000)
  .setOptions({
    title: 'NDVI Change Masked',
    colors: ['#2ca02c'], // Set the color of the bars to green
    hAxis: {title: 'NDVI Change Value', titleTextStyle: {color: '#333'}},
    vAxis: {title: 'Frequency', titleTextStyle: {color: '#333'}},
    legend: {position: 'none'}, // Remove the legend
    bar: {groupWidth: '95%'} // Adjust bar width
  })
);


// 24. Create a threshold mask for areas with NDVI change greater than 0.1
var ndvi_threshold = ndvi_change_masked.gt(0.1);
var threshold_mask = ndvi_threshold.updateMask(ndvi_threshold);

// 25. Add the threshold mask to the map
Map.addLayer(threshold_mask.clip(region), {palette:['red']}, 'NDVI Change > 0.1', false);

// 26. Calculate the area of the change mask in square kilometers
var area_in_km2 = threshold_mask.multiply(ee.Image.pixelArea().divide(1e6));
var total_area = ee.Number(area_in_km2.reduceRegion({
  reducer: ee.Reducer.sum(),
  geometry: region,
  scale: 1000
}).values().get(0));

// 27. Print the total area of significant NDVI change
print('Area of significant NDVI change (kmÂ²):', total_area);
